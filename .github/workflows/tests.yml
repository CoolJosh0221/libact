name: Libact tests

on: [push, pull_request]

jobs:
  test-linux-with-blas:
    name: Linux with BLAS/LAPACK (Python ${{ matrix.python-version }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y build-essential gfortran libatlas-base-dev liblapacke-dev python3-dev
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint coverage codecov
      - name: Install build tools
        run: |
          pip install meson-python meson ninja cython numpy
      - name: Install libact in editable mode
        run: |
          pip install --no-build-isolation -e . 2>&1 | tee build.log
      - name: Verify optional features were built
        run: |
          # Check build log for feature messages
          if grep -q "Building VarianceReduction" build.log; then
            echo "✓ VarianceReduction feature was built"
          else
            echo "✗ ERROR: VarianceReduction feature was NOT built (expected with BLAS/LAPACK)"
            exit 1
          fi
          if grep -q "Building HintSVM" build.log; then
            echo "✓ HintSVM feature was built"
          else
            echo "✗ ERROR: HintSVM feature was NOT built (expected with BLAS/LAPACK)"
            exit 1
          fi
          # Verify the compiled modules are importable
          python -c "from libact.query_strategies._variance_reduction import *; print('✓ _variance_reduction module imports successfully')"
          python -c "from libact.query_strategies._hintsvm import *; print('✓ _hintsvm module imports successfully')"
      - name: Run unittests
        run: |
          python -m unittest -v
      - name: Run coverage
        run: |
          coverage run --source libact --omit */tests/* -m unittest
      - name: Report coverage
        run: |
          coverage report
      - name: Upload coverage to Codecov
        run: |
          codecov

  test-linux-without-blas:
    name: Linux without BLAS/LAPACK (minimal install)
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install minimal system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y build-essential python3-dev
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
      - name: Install build tools
        run: |
          pip install meson-python meson ninja cython numpy
      - name: Install libact (should skip variance_reduction and hintsvm)
        run: |
          pip install --no-build-isolation -e . 2>&1 | tee install.log
      - name: Verify optional features were skipped
        run: |
          # Verify warning message appears
          if grep -q "BLAS/LAPACK libraries not found" install.log; then
            echo "✓ BLAS/LAPACK warning message found (as expected)"
          else
            echo "✗ WARNING: Expected BLAS/LAPACK warning message not found"
          fi
          # Verify features were skipped
          if grep -q "Skipping VarianceReduction" install.log; then
            echo "✓ VarianceReduction was correctly skipped"
          else
            echo "✗ ERROR: VarianceReduction skip message not found"
            exit 1
          fi
          if grep -q "Skipping HintSVM" install.log; then
            echo "✓ HintSVM was correctly skipped"
          else
            echo "✗ ERROR: HintSVM skip message not found"
            exit 1
          fi
          # Verify the modules don't exist (shouldn't be importable)
          python -c "try:
    from libact.query_strategies._variance_reduction import *
    print('✗ ERROR: _variance_reduction should not be importable without BLAS')
    exit(1)
except ImportError:
    print('✓ _variance_reduction correctly not available (as expected)')" || exit 1
          python -c "try:
    from libact.query_strategies._hintsvm import *
    print('✗ ERROR: _hintsvm should not be importable without BLAS')
    exit(1)
except ImportError:
    print('✓ _hintsvm correctly not available (as expected)')" || exit 1
      - name: Test basic import
        run: |
          python -c "from libact.base.dataset import Dataset; print('SUCCESS: Basic import works without BLAS/LAPACK')"
      - name: Run basic unittests
        run: |
          python -m unittest discover -s libact/base/tests -v || true
          python -m unittest discover -s libact/labelers/tests -v || true

  test-macos:
    name: macOS ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14]  # Intel and ARM64
        python-version: ['3.11', '3.12']

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install system dependencies
        run: |
          brew update
          brew install openblas
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
      - name: Install build tools
        run: |
          pip install meson-python meson ninja cython numpy
      - name: Install libact in editable mode
        run: |
          # Set up paths for OpenBLAS
          if [ -d "/opt/homebrew/opt/openblas" ]; then
            # Apple Silicon
            export LDFLAGS="-L/opt/homebrew/opt/openblas/lib"
            export CPPFLAGS="-I/opt/homebrew/opt/openblas/include"
            export PKG_CONFIG_PATH="/opt/homebrew/opt/openblas/lib/pkgconfig"
          else
            # Intel
            export LDFLAGS="-L/usr/local/opt/openblas/lib"
            export CPPFLAGS="-I/usr/local/opt/openblas/include"
            export PKG_CONFIG_PATH="/usr/local/opt/openblas/lib/pkgconfig"
          fi
          pip install --no-build-isolation -e . 2>&1 | tee build.log
      - name: Check build results
        run: |
          # Check if optional features were built (may or may not be depending on BLAS detection)
          if grep -q "Building VarianceReduction" build.log; then
            echo "✓ VarianceReduction feature was built"
            python -c "from libact.query_strategies._variance_reduction import *; print('✓ _variance_reduction module imports successfully')"
          else
            echo "⚠ VarianceReduction was skipped (BLAS/LAPACK not found)"
          fi
          if grep -q "Building HintSVM" build.log; then
            echo "✓ HintSVM feature was built"
            python -c "from libact.query_strategies._hintsvm import *; print('✓ _hintsvm module imports successfully')"
          else
            echo "⚠ HintSVM was skipped (BLAS/LAPACK not found)"
          fi
      - name: Test basic import
        run: |
          python -c "from libact.base.dataset import Dataset; print('SUCCESS: Basic import works on macOS')"
          python -c "import libact; print('SUCCESS: libact package imports correctly')"
      - name: Run unittests
        run: |
          python -m unittest -v || true

  test-windows:
    name: Windows (Python ${{ matrix.python-version }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
      - name: Install build tools
        run: |
          pip install meson-python meson ninja cython numpy
      - name: Install libact
        run: |
          pip install --no-build-isolation -e . 2>&1 | tee build.log
        shell: bash
      - name: Check build results
        run: |
          # On Windows, BLAS/LAPACK are typically not available without extra setup
          # The build should still succeed with optional features disabled
          if (Select-String -Path build.log -Pattern "Skipping VarianceReduction" -Quiet) {
            Write-Host "✓ VarianceReduction was skipped (expected without BLAS)"
          } elseif (Select-String -Path build.log -Pattern "Building VarianceReduction" -Quiet) {
            Write-Host "✓ VarianceReduction was built"
          }
          if (Select-String -Path build.log -Pattern "Skipping HintSVM" -Quiet) {
            Write-Host "✓ HintSVM was skipped (expected without BLAS)"
          } elseif (Select-String -Path build.log -Pattern "Building HintSVM" -Quiet) {
            Write-Host "✓ HintSVM was built"
          }
        shell: pwsh
      - name: Test basic import
        run: |
          python -c "from libact.base.dataset import Dataset; print('SUCCESS: Basic import works on Windows')"
          python -c "import libact; print('SUCCESS: libact package imports correctly')"
      - name: Run basic unittests
        run: |
          python -m unittest discover -s libact/base/tests -v
          python -m unittest discover -s libact/labelers/tests -v
        shell: bash
